/*!
 * VERSION: 0.3.0
 * DATE: 2015-04-22
 * GIT:https://github.com/shrekshrek/C3D-engine
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(t){var i="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;"function"==typeof define&&define.amd?define(["exports"],function(e){i.C3D=t(i,e)}):"undefined"!=typeof exports?t(i,exports):i.C3D=t(i,{})}(function(t,i){var e=t.C3D;i.VERSION="0.2.0",i.noConflict=function(){return t.C3D=e,this};var s=function(t){var i=[];for(var e in t)i.push(e);return i},a=function(t){var i=arguments.length;if(2>i||null==t)return t;for(var e=1;i>e;e++)for(var a=arguments[e],_=s(a),r=_.length,n=0;r>n;n++){var h=_[n];t[h]=a[h]}return t},_=function(t,i){var e,s=this;e=t&&Object.prototype.hasOwnProperty.call(t,"constructor")?t.constructor:function(){return s.apply(this,arguments)},a(e,s,i);var _=function(){this.constructor=e};return _.prototype=s.prototype,e.prototype=new _,t&&a(e.prototype,t),e.__super__=s.prototype,e};return i._isSupported=!1,i._browserPrefix="webkit",i._transformProperty="webkitTransform",i.checkSupport=function(){var t,e=document.createElement("div"),s=["","webkit","Moz","O","ms"],a=s.length;for(t=0;a>t;t++)if(s[t]+"Perspective"in e.style)return i._transformProperty=s[t]+"Transform",i._isSupported=!0,i._browserPrefix=s[t],!0;return!1},i.browserPrefix=function(t){return arguments.length?i._browserPrefix+t:i._browserPrefix},i.getRandomColor=function(){return"#"+("00000"+(16777216*Math.random()<<0).toString(16)).slice(-6)},i.rgb2hex=function(t,i,e){return(t<<16|i<<8|e).toString(16)},i.hex2rgb=function(t){var i=Math.floor("0x"+t),e=i>>16&255,s=i>>8&255,a=255&i;return[e,s,a]},i.getDistance=function(t,i){switch(arguments.length){case 1:return Math.pow(Math.pow(t.x(),2)+Math.pow(t.y(),2)+Math.pow(t.z(),2),.5);case 2:return Math.pow(Math.pow(i.x()-t.x(),2)+Math.pow(i.y()-t.y(),2)+Math.pow(i.z()-t.z(),2),.5)}},i.positionRotate3D=function(t,i){var e=Math.sin(i[2]/180*Math.PI),s=Math.cos(i[2]/180*Math.PI),a=t.x()*s-t.y()*e,_=t.y()*s+t.x()*e,r=t.z(),n=Math.sin(i[1]/180*Math.PI),h=Math.cos(i[1]/180*Math.PI),o=a*h+r*n,l=_,p=r*h-a*n,u=Math.sin(i[0]/180*Math.PI),d=Math.cos(i[0]/180*Math.PI),c=o,f=l*d-p*u,m=p*d+l*u;return{x:c,y:f,z:m}},i.Object3D=function(){this.initialize.apply(this,arguments)},a(i.Object3D.prototype,{__position:{x:0,y:0,z:0},__isPositionUpdate:!1,x:function(t){return arguments.length?(this.__position.x=t,this.__isPositionUpdate=!0,this):this.__position.x},y:function(t){return arguments.length?(this.__position.y=t,this.__isPositionUpdate=!0,this):this.__position.y},z:function(t){return arguments.length?(this.__position.z=t,this.__isPositionUpdate=!0,this):this.__position.z},position:function(t,i,e){switch(arguments.length){case 0:return this.__position;case 1:return this.__position.x=t,this.__position.y=t,this.__position.z=t,this.__isPositionUpdate=!0,this;case 2:return this.__position.x=t,this.__position.y=i,this.__isPositionUpdate=!0,this;case 3:return this.__position.x=t,this.__position.y=i,this.__position.z=e,this.__isPositionUpdate=!0,this}},move:function(t,i,e){switch(arguments.length){case 0:return this.__position;case 1:return this.__position.x+=t,this.__position.y+=t,this.__position.z+=t,this.__isPositionUpdate=!0,this;case 2:return this.__position.x+=t,this.__position.y+=i,this.__isPositionUpdate=!0,this;case 3:return this.__position.x+=t,this.__position.y+=i,this.__position.z+=e,this.__isPositionUpdate=!0,this}},__rotation:{x:0,y:0,z:0},__isRotationUpdate:!1,rotationX:function(t){return arguments.length?(this.__rotation.x=t,this.__isRotationUpdate=!0,this):this.__rotation.x},rotationY:function(t){return arguments.length?(this.__rotation.y=t,this.__isRotationUpdate=!0,this):this.__rotation.y},rotationZ:function(t){return arguments.length?(this.__rotation.z=t,this.__isRotationUpdate=!0,this):this.__rotation.z},rotation:function(t,i,e){switch(arguments.length){case 0:return this.__rotation;case 1:return this.__rotation.x=t,this.__rotation.y=t,this.__rotation.z=t,this.__isRotationUpdate=!0,this;case 2:return this.__rotation.x=t,this.__rotation.y=i,this.__isRotationUpdate=!0,this;case 3:return this.__rotation.x=t,this.__rotation.y=i,this.__rotation.z=e,this.__isRotationUpdate=!0,this}},rotate:function(t,i,e){switch(arguments.length){case 0:return this.__rotation;case 1:return this.__rotation.x+=t,this.__rotation.y+=t,this.__rotation.z+=t,this.__isRotationUpdate=!0,this;case 2:return this.__rotation.x+=t,this.__rotation.y+=i,this.__isRotationUpdate=!0,this;case 3:return this.__rotation.x+=t,this.__rotation.y+=i,this.__rotation.z+=e,this.__isRotationUpdate=!0,this}},__scale:{x:0,y:0,z:0},__isScaleUpdate:!1,scaleX:function(t){return arguments.length?(this.__scale.x=t,this.__isScaleUpdate=!0,this):this.__scale.x},scaleY:function(t){return arguments.length?(this.__scale.y=t,this.__isScaleUpdate=!0,this):this.__scale.y},scaleZ:function(t){return arguments.length?(this.__scale.z=t,this.__isScaleUpdate=!0,this):this.__scale.z},scale:function(t,i,e){switch(arguments.length){case 0:return this.__scale;case 1:return this.__scale.x=t,this.__scale.y=t,this.__scale.z=t,this.__isScaleUpdate=!0,this;case 2:return this.__scale.x=t,this.__scale.y=i,this.__isScaleUpdate=!0,this;case 3:return this.__scale.x=t,this.__scale.y=i,this.__scale.z=e,this.__isScaleUpdate=!0,this}},__size:{x:0,y:0,z:0},__isSizeUpdate:!1,width:function(t){return arguments.length?(this.__size.x=t,this.__isSizeUpdate=!0,this):this.__size.x},height:function(t){return arguments.length?(this.__size.y=t,this.__isSizeUpdate=!0,this):this.__size.y},depth:function(t){return arguments.length?(this.__size.z=t,this.__isSizeUpdate=!0,this):this.__size.z},size:function(t,i,e){switch(arguments.length){case 0:return this.__size;case 1:return this.__size.x=t,this.__size.y=t,this.__size.z=t,this.__isSizeUpdate=!0,this;case 2:return this.__size.x=t,this.__size.y=i,this.__isSizeUpdate=!0,this;case 3:return this.__size.x=t,this.__size.y=i,this.__size.z=e,this.__isSizeUpdate=!0,this}},initialize:function(){this.__position={x:0,y:0,z:0},this.__isPositionUpdate=!0,this.__rotation={x:0,y:0,z:0},this.__isRotationUpdate=!0,this.__scale={x:1,y:1,z:1},this.__isScaleUpdate=!0,this.__size={x:0,y:0,z:0},this.__isSizeUpdate=!0,this.children=[]},destroy:function(){for(var t in this.children)this.children[t].destroy();this.children=[]},parent:null,children:null,addChild:function(t){t.parent&&t.parent.removeChild(t);for(var i in this.children)if(this.children[i]===t)return this;return t.parent=this,this.children.push(t),this},removeChild:function(t){for(var i=this,e=this.children.length-1;e>=0;e--)if(this.children[e]===t)return i.children.splice(e,1),t.parent=null,this;return this},update:function(){return this}}),i.Object3D.extend=_,i.Sprite3D=i.Object3D.extend({el:null,initialize:function(t){if(i.Sprite3D.__super__.initialize.apply(this,[t]),!i._isSupported&&!i.checkSupport())throw"this browser does not support C3D!!!";var e,s;t&&t.el?(e=t.el,s=e.style,"static"===s.position&&(s.position="relative")):(e=document.createElement("div"),s=e.style,s.position="absolute",s.margin="0px",s.padding="0px"),e.style[i._browserPrefix+"Transform"]="translateZ(0px)",e.style[i._browserPrefix+"TransformStyle"]="preserve-3d",this.el=e,e.le=this},destroy:function(){i.Sprite3D.__super__.destroy.apply(this),this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el)},update:function(){if(i.Sprite3D.__super__.update.apply(this),this.__isPositionUpdate||this.__isRotationUpdate||this.__isScaleUpdate||this.__isSizeUpdate){this.__isPositionUpdate=!1,this.__isRotationUpdate=!1,this.__isScaleUpdate=!1,this.__isSizeUpdate=!1;var t=Number(this.__size.x)?this.__size.x:0,e=Number(this.__size.y)?this.__size.y:0,s=Number(this.__size.z)?this.__size.z:0;this.el.style[i._browserPrefix+"Transform"]="translate3d("+(this.__position.x-t/2)+"px,"+(this.__position.y-e/2)+"px,"+(this.__position.z-s/2)+"px) rotateX("+this.__rotation.x+"deg) rotateY("+this.__rotation.y+"deg) rotateZ("+this.__rotation.z+"deg) scale3d("+this.__scale.x+", "+this.__scale.y+", "+this.__scale.z+") "}return this},addChild:function(t){return i.Sprite3D.__super__.addChild.apply(this,[t]),this.el&&t.el&&this.el.appendChild(t.el),this},removeChild:function(t){return i.Sprite3D.__super__.removeChild.apply(this,[t]),t.el&&t.el.parentNode&&t.el.parentNode.removeChild(t.el),this},on:function(t){if("object"==typeof t)for(var i in t)this.el.addEventListener(i,t[i],!1);else 2===arguments.length?this.el.addEventListener(arguments[0],arguments[1],!1):3===arguments.length&&this.el.addEventListener(arguments[0],arguments[1],arguments[2]);return this},off:function(t){if("object"==typeof t)for(var i in t)this.el.removeEventListener(i,t[i],!1);else 2===arguments.length&&this.el.removeEventListener(arguments[0],arguments[1],!1);return this},buttonMode:function(t){return this.el.style.cursor=t?"pointer":"auto",this},__material:null,__isMaterialUpdate:!1,material:function(t){return this.__material=t,this.__isMaterialUpdate=!0,this}}),i.Stage=i.Sprite3D.extend({camera:null,__fix1:null,__fix2:null,initialize:function(t){i.Stage.__super__.initialize.apply(this,[t]),t&&t.el||(this.el.style.top="0px",this.el.style.left="0px",this.el.style.width="0px",this.el.style.height="0px"),this.el.style[i._browserPrefix+"Perspective"]="800px",this.el.style[i._browserPrefix+"TransformStyle"]="flat",this.el.style[i._browserPrefix+"Transform"]="",this.el.style.overflow="hidden",this.__fix1=new i.Sprite3D,this.__fix1.el.style.top="50%",this.__fix1.el.style.left="50%",this.el.appendChild(this.__fix1.el),this.__fix2=new i.Sprite3D,this.__fix1.el.appendChild(this.__fix2.el),this.camera=new i.Camera},update:function(){if(this.__isSizeUpdate||this.camera.__isFovUpdate){this.__isSizeUpdate=!1;var t=this.__size.x,e=this.__size.y;this.el.style.width=parseInt(t)+"px",this.el.style.height=parseInt(e)+"px",this.camera.__isFovUpdate=!1;var s=.5/Math.tan(.5*this.camera.fov()/180*Math.PI)*this.height();this.el.style[i._browserPrefix+"Perspective"]=s+"px",this.__fix1.position(0,0,s).update()}(this.camera.__isPositionUpdate||this.camera.__isRotationUpdate)&&(this.camera.__isPositionUpdate=!1,this.camera.__isRotationUpdate=!1,this.__fix1.rotation(-this.camera.rotationX(),-this.camera.rotationY(),-this.camera.rotationZ()).update(),this.__fix2.position(-this.camera.x(),-this.camera.y(),-this.camera.z()).update()),this.__isMaterialUpdate&&(this.__isMaterialUpdate=!1,this.__material&&(this.__material.image?(this.el.style.background="url("+this.__material.image+")",this.el.style.backgroundSize="100% 100%"):this.__material.color&&(this.el.style.backgroundColor=this.__material.color),this.__material.alpha&&(this.el.style.opacity=this.__material.alpha)))},addChild:function(t){this.__fix2.addChild(t)},removeChild:function(t){this.__fix2.removeChild(t)}}),i.Camera=i.Object3D.extend({__fov:null,__target:null,__isFovUpdate:null,initialize:function(t){i.Camera.__super__.initialize.apply(this,[t]),this.__fov=75,this.__isFovUpdate=!0,this.__target={x:0,y:0,z:0}},fov:function(t){return arguments.length?(this.__fov=t,this.__isFovUpdate=!0,this):this.__fov}}),i.Plane=i.Sprite3D.extend({initialize:function(){i.Plane.__super__.initialize.apply(this)},update:function(){if(this.__isSizeUpdate){var t=Number(this.__size.x)?this.__size.x:0,e=Number(this.__size.y)?this.__size.y:0;this.el.style.width=t+"px",this.el.style.height=e+"px",this.__size.z=0}i.Plane.__super__.update.apply(this),this.__isMaterialUpdate&&(this.__isMaterialUpdate=!1,this.__material&&(this.__material.image?(this.el.style.background="url("+this.__material.image+")",this.el.style.backgroundSize="100% 100%"):this.__material.color&&(this.el.style.backgroundColor=this.__material.color),this.__material.alpha&&(this.el.style.opacity=this.__material.alpha)))}}),i.Cube=i.Sprite3D.extend({front:null,back:null,left:null,right:null,up:null,down:null,initialize:function(){i.Cube.__super__.initialize.apply(this),this.front=new i.Plane,this.addChild(this.front),this.back=new i.Plane,this.addChild(this.back),this.left=new i.Plane,this.addChild(this.left),this.right=new i.Plane,this.addChild(this.right),this.up=new i.Plane,this.addChild(this.up),this.down=new i.Plane,this.addChild(this.down)},update:function(){if(this.__isSizeUpdate){var t=this.__size.x,e=this.__size.y,s=this.__size.z;this.front.size(t,e,0).position(0,0,-s/2).rotation(0,0,0).update(),this.back.size(t,e,0).position(0,0,s/2).rotation(0,180,0).update(),this.left.size(s,e,0).position(-t/2,0,0).rotation(0,90,0).update(),this.right.size(s,e,0).position(t/2,0,0).rotation(0,-90,0).update(),this.up.size(t,s,0).position(0,-e/2,0).rotation(-90,0,0).update(),this.down.size(t,s,0).position(0,e/2,0).rotation(90,0,0).update()}this.__size.x=0,this.__size.y=0,this.__size.z=0,this.__isSizeUpdate=!1,i.Cube.__super__.update.apply(this),this.__isMaterialUpdate&&(this.__isMaterialUpdate=!1,this.__material&&(this.__material.front?this.front.material({image:this.__material.front}).update():this.front.material(this.__material).update(),this.__material.back?this.back.material({image:this.__material.back}).update():this.back.material(this.__material).update(),this.__material.left?this.left.material({image:this.__material.left}).update():this.left.material(this.__material).update(),this.__material.right?this.right.material({image:this.__material.right}).update():this.right.material(this.__material).update(),this.__material.up?this.up.material({image:this.__material.up}).update():this.up.material(this.__material).update(),this.__material.down?this.down.material({image:this.__material.down}).update():this.down.material(this.__material).update()))}}),i});
